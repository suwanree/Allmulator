<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Graph Visualization</title>
    <style>
        body { font-family: sans-serif; padding: 20px; display: flex; gap: 20px; }
        
        /* ì™¼ìª½ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls { width: 250px; padding: 20px; background: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); height: fit-content; }
        .controls input, .controls button { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .controls button { background: #333; color: white; border: none; cursor: pointer; }
        .controls button:hover { background: #555; }
        .controls h3 { margin-top: 0; }

        /* ì˜¤ë¥¸ìª½ ì‹œê°í™” ì˜ì—­ */
        #canvas-container {
            flex-grow: 1;
            position: relative;
            background: #fff;
            border: 2px solid #eee;
            border-radius: 8px;
            height: 600px;
            overflow: hidden;
        }

        /* ë…¸ë“œ ìŠ¤íƒ€ì¼ */
        .node {
            width: 40px; height: 40px;
            background: white; border: 3px solid #333;
            border-radius: 50%;
            position: absolute;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; cursor: pointer;
            z-index: 10;
            transition: background 0.2s, transform 0.2s;
        }
        .node:hover { transform: scale(1.1); }
        .node.selected { background: #ffeb3b; border-color: #fbc02d; transform: scale(1.2); }

        /* ì—£ì§€ (SVG) */
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        line { stroke: #333; stroke-width: 2; }
    </style>
</head>
<body>

    <div class="controls">
        <h3>1. ê·¸ë˜í”„ ìƒì„±</h3>
        <input type="number" id="vCount" placeholder="ë…¸ë“œ ê°œìˆ˜ (V)" value="9">
        <button onclick="initGraph()">Vê°œ ë…¸ë“œ ìƒì„±</button>

        <hr>

        <h3>2. ëœë¤ ì—°ê²°</h3>
        <input type="number" id="eCount" placeholder="ì¶”ê°€í•  ì—£ì§€ (E)" value="3">
        <button onclick="addRandomEdges()">ëœë¤ ì—°ê²° (Add E)</button>

        <hr>
        <p>ğŸ’¡ <b>ìˆ˜ë™ ì—°ê²°:</b><br>ë‘ ê°œì˜ ë…¸ë“œë¥¼ ì°¨ë¡€ë¡œ í´ë¦­í•˜ì„¸ìš”.</p>
        <button onclick="location.href='index.html'" style="background:#dc3545">ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <div id="canvas-container">
        <svg id="edge-layer"></svg>
        <div id="node-layer"></div>
    </div>

    <script src="graph.js"></script>
    <script>
        let graphInstance = null;
        let nodePositions = {}; // ë…¸ë“œ ì¢Œí‘œ ì €ì¥ìš© { id: {x, y} }
        let selectedNode = null; // ì—°ê²°ì„ ìœ„í•´ ì„ íƒëœ ì²« ë²ˆì§¸ ë…¸ë“œ
        let currentNodeCount = 0;

        Module.onRuntimeInitialized = function() {
            console.log("Wasm Loaded");
        };

        // 1. ê·¸ë˜í”„ ì´ˆê¸°í™” & ë…¸ë“œ ë°°ì¹˜ (ê²©ì ëª¨ì–‘)
        function initGraph() {
            const V = parseInt(document.getElementById('vCount').value);
            if(V < 1 || V > 100) return alert("1 ~ 100 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            currentNodeCount = V;
            graphInstance = new Module.Graph(V); // C++ ê°ì²´ ìƒì„±
            selectedNode = null;
            
            renderNodesGrid(V); // í™”ë©´ ê·¸ë¦¬ê¸°
            drawEdges(); // (ì´ˆê¸°ì—” ì—†ìŒ)
        }

        // 2. ê²©ì í˜•íƒœë¡œ ë…¸ë“œ ë°°ì¹˜ ê³„ì‚° ë° ë Œë”ë§
        function renderNodesGrid(V) {
            const container = document.getElementById('node-layer');
            const svgLayer = document.getElementById('edge-layer');
            container.innerHTML = '';
            svgLayer.innerHTML = ''; // ì—£ì§€ ì´ˆê¸°í™”

            const containerWidth = document.getElementById('canvas-container').clientWidth;
            const containerHeight = document.getElementById('canvas-container').clientHeight;
            
            // ê²©ì ê³„ì‚° (Cols x Rows)
            const cols = Math.ceil(Math.sqrt(V)); 
            const rows = Math.ceil(V / cols);
            
            const xGap = containerWidth / (cols + 1);
            const yGap = containerHeight / (rows + 1);

            for(let i = 1; i <= V; i++) {
                // 0-based index for calculation
                const idx = i - 1;
                const col = idx % cols;
                const row = Math.floor(idx / cols);

                const x = xGap * (col + 1);
                const y = yGap * (row + 1);

                // ì¢Œí‘œ ì €ì¥
                nodePositions[i] = {x, y};

                // DOM ìƒì„±
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'node';
                nodeDiv.innerText = i;
                nodeDiv.style.left = `${x - 20}px`; // ì¤‘ì•™ ì •ë ¬ ë³´ì • (width/2)
                nodeDiv.style.top = `${y - 20}px`;
                
                // í´ë¦­ ì´ë²¤íŠ¸ (ìˆ˜ë™ ì—°ê²°)
                nodeDiv.onclick = () => handleNodeClick(i, nodeDiv);

                container.appendChild(nodeDiv);
            }
        }

        // 3. ìˆ˜ë™ ì—°ê²° ë¡œì§
        function handleNodeClick(id, element) {
            // ì²« ë²ˆì§¸ ì„ íƒ
            if (selectedNode === null) {
                selectedNode = id;
                element.classList.add('selected');
            } 
            // ë‘ ë²ˆì§¸ ì„ íƒ (ì—°ê²° ì‹œë„)
            else {
                if (selectedNode === id) {
                    // ê°™ì€ ê±° ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì·¨ì†Œ
                    selectedNode = null;
                    element.classList.remove('selected');
                    return;
                }

                // C++ ì—°ê²° í•¨ìˆ˜ í˜¸ì¶œ
                graphInstance.connection(selectedNode, id);
                
                // ì„ íƒ í•´ì œ UI ì²˜ë¦¬
                const prevNode = document.querySelectorAll('.node')[selectedNode - 1]; // ê°„ë‹¨íˆ ì¸ë±ìŠ¤ë¡œ ì ‘ê·¼
                prevNode.classList.remove('selected');
                selectedNode = null;

                // í™”ë©´ ê°±ì‹ 
                drawEdges();
            }
        }

        // 4. ëœë¤ ì—£ì§€ ì¶”ê°€
        function addRandomEdges() {
            if(!graphInstance) return alert("ê·¸ë˜í”„ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.");
            const E = parseInt(document.getElementById('eCount').value);
            
            graphInstance.addRandomEdges(E); // C++ í˜¸ì¶œ
            drawEdges(); // ê·¸ë¦¬ê¸°
        }

        // 5. ì—£ì§€ ê·¸ë¦¬ê¸° (C++ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜´)
        function drawEdges() {
            const svgLayer = document.getElementById('edge-layer');
            svgLayer.innerHTML = ''; // ê¸°ì¡´ ì„  ì‚­ì œ

            // C++ì—ì„œ ì¸ì ‘ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (Vector<Vector<int>>)
            const adj = graphInstance.getAdjacencyList();
            
            // ì¤‘ë³µ ê·¸ë¦¬ê¸° ë°©ì§€ë¥¼ ìœ„í•œ ì§‘í•© (1-2 ê·¸ë ¸ìœ¼ë©´ 2-1ì€ íŒ¨ìŠ¤)
            const drawnEdges = new Set();

            for (let u = 1; u <= currentNodeCount; u++) {
                const neighbors = adj.get(u); // VectorInt
                
                for (let j = 0; j < neighbors.size(); j++) {
                    const v = neighbors.get(j);
                    
                    // "ì‘ì€ ë²ˆí˜¸ -> í° ë²ˆí˜¸" ì¼ ë•Œë§Œ ê·¸ë¦¬ê¸° (ì–‘ë°©í–¥ì´ë¯€ë¡œ í•˜ë‚˜ë§Œ ê·¸ë¦¬ë©´ ë¨)
                    if (u < v) {
                        const start = nodePositions[u];
                        const end = nodePositions[v];

                        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        line.setAttribute("x1", start.x);
                        line.setAttribute("y1", start.y);
                        line.setAttribute("x2", end.x);
                        line.setAttribute("y2", end.y);
                        
                        svgLayer.appendChild(line);
                    }
                }
            }
        }
    </script>
</body>
</html>